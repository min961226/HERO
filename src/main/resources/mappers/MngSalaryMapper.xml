<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nextLevel.hero.mngSalary.model.dao.MngSalaryMapper">

	<resultMap type="com.nextLevel.hero.mngSalary.model.dto.MngSalaryDTO" id="annualSalaryResultMap">
		<result property="departmentName" column="DEPARTMENT_NAME"/>
		<result property="salaryStepByRank" column="SALARY_STEP_BY_RANK"/>
		<result property="rank" column="RANK"/>
		<result property="salaryStep" column="SALARY_STEP"/>
		<result property="salStepAmount" column="AMOUNT"/>
		<result property="salaryStepUpdatedDate" column="START_DATE"/>
		<result property="changeStartDate" column="CHANGE_START_DATE"/>
	
		<association property="memberInfo" resultMap="memberInfoResult"/>
	</resultMap>
	
	<resultMap type="com.nextLevel.hero.mngSalary.model.dto.MemberInfoDTO" id="memberInfoResult">
		<id property="companyNo" column="COMPANY_NO"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberName" column="MEMBER_NAME"/>		
		<result property="hireDate" column="HIRE_DATE"/>		
	</resultMap>
	
	<resultMap type="com.nextLevel.hero.mngSalary.model.dto.MemberMonthlyPayDTO" id="latestMonthlyResult">
		<result property="payCategory" column="MONTHLY_PAY_CATEGORY"/>
		<result property="monthlyStartDate" column="CHANGE_START_DATE"/>
		<result property="amount" column="AMOUNT"/>
		<result property="note" column="DESCRIPTION"/>
		<result property="deductionYn" column="DEDUCTION_YN"/>
		<result property="monthlyStopDate" column="STOP_DATE"/>
	
		<association property="memberInfo" resultMap="memberInfoResult"/>
	</resultMap>
	
	<resultMap type="com.nextLevel.hero.mngSalary.model.dto.MngDeductFourInsDTO" id="fourInsResultMap">
		<id property="companyNo" column="COMPANY_NO"/>
		<id property="idNo" column="ID_NO"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberName" column="MEMBER_NAME"/>
		<result property="departmentName" column="DEPARTMENT_NAME"/>
		<result property="divNo" column="DIV_NO"/>
		<result property="validateDate" column="START_DATE"/>
		<result property="healthYn" column="HEALTH"/>
		<result property="pensionYn" column="PENSION"/>
		<result property="unemployeeYn" column="UNEMPLOYEE"/>
		<result property="industryYn" column="INDUSTRY"/>
	</resultMap>
	
	<resultMap type="com.nextLevel.hero.mngSalary.model.dto.MemberInsFeeDTO" id="memberInsFeeResult">
		<id property="companyNo" column="COMPANY_NO"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberName" column="MEMBER_NAME"/>
		<result property="hireDate" column="HIRE_DATE"/>
		<result property="healthCoverDate" column="HEALTH_INSURANCE_COVERAGE_DATE"/>
		<result property="healthSal" column="MONTHLY_HEALTH_AVERAGE_SALARY"/>
		<result property="healthInsFee" column="HEALTH_INSURANCE_FEE"/>
		<result property="longtermFee" column="LONG_TERM_CARE_FEE"/>
		<result property="pensionCoverDate" column="NATIONAL_PENSION_COVERAGE_DATE"/>
		<result property="pensionSal" column="MONTHLY_PENSION_AVERAGE_SALARY"/>
		<result property="pensionFee" column="PENSION_INSURANCE_FEE"/>
	</resultMap> 
	
	<resultMap type="com.nextLevel.hero.mngSalary.model.dto.MngAccountDTO" id="memberAccountResultMap">
		<id property="companyNo" column="COMPANY_NO"/>
		<result property="departmentName" column="DEPARTMENT_NAME"/>
		<result property="rank" column="RANK"/>
		<result property="bankCode" column="BANK_CODE"/>
		<result property="bankName" column="BANK_NAME"/>
		<result property="accountNo" column="ACCOUNT_NO"/>
		<result property="enrollDate" column="ENROLL_DATE"/>
		
		
		<association property="memberInfo" resultMap="memberInfoResult"/>
	</resultMap>
	
	
	<select id="listMngAnnualSalary" resultMap="annualSalaryResultMap" parameterType="com.nextLevel.hero.mngSalary.model.dto.MngSalaryDTO">
		SELECT
               A.COMPANY_NO
             , A.MEMBER_NO
             , A.KOREAN_NAME AS MEMBER_NAME
             , B.DEPARTMENT_NAME
             , D.RANK
             , D.SALARY_STEP
             , D.AMOUNT
             , C.START_DATE
          FROM TBL_EMPLOYEE A
          JOIN TBL_DEPARTMENT B ON (A.DEPARTMENT_NO = B.DEPARTMENT_NO)
          JOIN TBL_EMP_SALARY_STEP_UPDATE C ON(A.MEMBER_NO = C.MEMBER_NO)
          JOIN TBL_RANK_SALARY_STEP D ON (C.SALARY_STEP_BY_RANK = D.SALARY_STEP_BY_RANK)
         WHERE A.COMPANY_NO = #{ companyNo }
           AND C.SALARY_STEP_BY_RANK = D.SALARY_STEP_BY_RANK
           AND (A.MEMBER_NO, C.START_DATE) IN (SELECT 
                                                      A1.MEMBER_NO
                                                    , MAX(C1.START_DATE)AS START_DATE
                                                 FROM TBL_EMPLOYEE A1
                                                 JOIN TBL_EMP_SALARY_STEP_UPDATE C1 ON (A1.MEMBER_NO = C1.MEMBER_NO)
                                                <where>
                                                	<if test="searchDate != null and '' != searchDate">
                                                	   C1.START_DATE <![CDATA[<=]]> #{ searchDate }
                                                	</if>
                                                	<if test="(searchDate == null) or '' == searchDate">
                                           			   C1.START_DATE <![CDATA[<=]]> SYSDATE
                                                    </if>
                                                </where> 
                                                GROUP BY A1.MEMBER_NO)
         <if test = "searchCondition == 'searchDeptName'">
           AND B.DEPARTMENT_NAME LIKE '%' || #{ searchValue } || '%'
         </if>
         <if test = "searchCondition == 'searchMemberName'">
           AND A.KOREAN_NAME = #{ searchValue }
         </if>
         ORDER BY B.DEPARTMENT_NO  	
	</select>
	
	<select id="listMonthlyPay" parameterType="com.nextLevel.hero.mngSalary.model.dto.MngSalaryDTO" resultMap="latestMonthlyResult">
	    SELECT
		       A.COMPANY_NO
             , A.MEMBER_NO
		     , A.MONTHLY_PAY_CATEGORY
		     , A.AMOUNT
		     , A.CHANGE_START_DATE
		     , A.DEDUCTION_YN
		     , A.SALARY_NO 
		     , A.STOP_DATE
	      FROM TBL_EMP_MONTHLY_SALARY_LIST A
	     WHERE A.COMPANY_NO = #{ companyNo }
	     <if test="(searchDate == null) or '' == searchDate">
                AND A.CHANGE_START_DATE <![CDATA[<=]]> SYSDATE
                AND A.USE_STATUS = 'Y'
         </if>
         <if test="(searchDate != null) and '' != searchDate">
                AND A.CHANGE_START_DATE <![CDATA[<=]]> #{ searchDate } 
         </if>
	</select>
	
	
	<select id="listMonthlyPay2" parameterType="com.nextLevel.hero.mngSalary.model.dto.MngSalaryDTO" resultMap="latestMonthlyResult">
	    SELECT
		       A.COMPANY_NO
             , A.MEMBER_NO
		     , A.MONTHLY_PAY_CATEGORY
		     , A.CHANGE_START_DATE
		     , A.STOP_DATE
	      FROM TBL_EMP_MONTHLY_SALARY_LIST A
	     WHERE A.COMPANY_NO = #{ companyNo }
         <if test="(searchDate != null) and '' != searchDate">
                AND A.CHANGE_START_DATE <![CDATA[<=]]> #{ searchDate }
                AND A.STOP_DATE IN (SELECT 
                                           A1.STOP_DATE
                                      FROM TBL_EMP_MONTHLY_SALARY_LIST A1
                                      WHERE A1.STOP_DATE <![CDATA[<=]]> #{ searchDate })
         </if>
         <if test="(searchDate == null) or '' == searchDate">
                AND A.CHANGE_START_DATE <![CDATA[<=]]> SYSDATE
                AND A.USE_STATUS = 'Y'
         </if>                                     
	</select>
	
	
	
	
	<select id="listMonthlySalary" parameterType="com.nextLevel.hero.mngSalary.model.dto.MngSalaryDTO" resultMap="latestMonthlyResult">
		SELECT
		       A.COMPANY_NO
             , A.MONTHLY_PAY_CATEGORY
		     , A.AMOUNT
		     , A.DESCRIPTION
		     , A.CHANGE_START_DATE
		     , A.DEDUCTION_YN
		     , A.SALARY_NO 
		     , A.STOP_DATE
	      FROM TBL_EMP_MONTHLY_SALARY_LIST A
	     WHERE A.COMPANY_NO = #{ companyNo }
	       AND A.MEMBER_NO = #{ memberNo }
	    <if test="(searchDate != null) and '' != searchDate">
           AND A.CHANGE_START_DATE <![CDATA[<=]]> #{ searchDate } 
        </if>
        <if test="(searchDate == null) or '' == searchDate">
           AND A.CHANGE_START_DATE <![CDATA[<=]]> SYSDATE
           AND A.USE_STATUS = 'Y'
        </if>
	</select>
	
	
	<select id="listMngFourInsuranceList" parameterType="_int" resultMap="fourInsResultMap">
		SELECT
		       A.COMPANY_NO
		     , A.MEMBER_NO
		     , A.KOREAN_NAME AS MEMBER_NAME
		     , A.ID_NO
		     , B.DEPARTMENT_NAME
		     , C.DIV_NO
		     , C.START_DATE
		     , C.HEALTH
		     , C.PENSION
		     , C.UNEMPLOYEE
		     , C.INDUSTRY
		  FROM TBL_EMPLOYEE A
		  JOIN TBL_DEPARTMENT B ON (A.DEPARTMENT_NO = B.DEPARTMENT_NO)
		  JOIN TBL_FOUR_INSURANCE_DEDUCT C ON (A.MEMBER_NO = C.MEMBER_NO)
		 WHERE A.COMPANY_NO = #{ companyNo }
		 ORDER BY B.DEPARTMENT_NO			
	</select>
	
	<update id="updateFourInsuranceList" parameterType="com.nextLevel.hero.mngSalary.model.dto.MngDeductFourInsDTO">
	    UPDATE TBL_FOUR_INSURANCE_DEDUCT
	       SET 
	           START_DATE = #{ validateDate }
	         , HEALTH = #{ healthYn }
	         , PENSION = #{ pensionYn }
	         , UNEMPLOYEE = #{ unemployeeYn }
	         , INDUSTRY = #{ industryYn }	         
	     WHERE COMPANY_NO = #{ companyNo }
	      AND  DIV_NO = #{ divNo }
	      AND  MEMBER_NO = #{ memberNo }
	      AND  ID_NO = #{ idNo }
	</update>
	
	<insert id="insertFourInsHistory" parameterType="com.nextLevel.hero.mngSalary.model.dto.MngDeductFourInsDTO">
	    INSERT
	      INTO TBL_FOUR_INS_HISTORY
	    VALUES
	    (
	      SEQ_FOUR_UPDATE_NO.NEXTVAL
	    , #{ memberNo }
	    , #{ validateDate }
	    , SYSDATE
	    , #{ healthYn }
	    , #{ pensionYn }
	    , #{ unemployeeYn }
	    , #{ industryYn }
	    , #{ companyNo }
	    , #{ divNo }
	    )
	</insert>
	
	<select id="listMngNationalHealthInsurancePension" resultMap="memberInsFeeResult">
		SELECT
               A.COMPANY_NO
             , A.MEMBER_NO
             , A.KOREAN_NAME AS MEMBER_NAME
             , A.HIRE_DATE
             , B.HEALTH_INSURANCE_COVERAGE_DATE
             , B.MONTHLY_HEALTH_AVERAGE_SALARY
             , B.HEALTH_INSURANCE_FEE
             , B.LONG_TERM_CARE_FEE
             , B.NATIONAL_PENSION_COVERAGE_DATE
             , B.MONTHLY_PENSION_AVERAGE_SALARY
             , B.PENSION_INSURANCE_FEE
          FROM TBL_EMPLOYEE A
          JOIN TBL_PERSONAL_INSURANCE_FEE B ON (A.MEMBER_NO = B.MEMBER_NO)         
         WHERE A.COMPANY_NO = #{ companyNo }
           AND (A.MEMBER_NO, B.HEALTH_INSURANCE_COVERAGE_DATE, B.NATIONAL_PENSION_COVERAGE_DATE) IN (SELECT 
                                                                                                            A1.MEMBER_NO
                                                                                                          , MAX(B1.HEALTH_INSURANCE_COVERAGE_DATE)AS HEALTH_INSURANCE_COVERAGE_DATE
                                                                                                          , MAX(B1.NATIONAL_PENSION_COVERAGE_DATE)AS NATIONAL_PENSION_COVERAGE_DATE
                                            
                                                                                                       FROM TBL_EMPLOYEE A1
                                                                                                       JOIN TBL_PERSONAL_INSURANCE_FEE B1 ON (A1.MEMBER_NO = B1.MEMBER_NO)
                                                                                                     <where>
                                                                                                         <if test="(searchDate != null) and '' != searchDate">  
                                                                                                             B1.HEALTH_INSURANCE_COVERAGE_DATE <![CDATA[<=]]> #{ searchDate } 
                                                                                                         OR  B1.NATIONAL_PENSION_COVERAGE_DATE <![CDATA[<=]]> #{ searchDate } 
                                                                                                         </if>
                                                                                                         <if test="(searchDate == null) or '' == searchDate">
                                                                                                             B1.HEALTH_INSURANCE_COVERAGE_DATE <![CDATA[<=]]> SYSDATE 
                                                                                                         OR  B1.NATIONAL_PENSION_COVERAGE_DATE <![CDATA[<=]]> SYSDATE 
                                                                                                         </if>
                                                                                                     </where>
                                                                                                       GROUP BY A1.MEMBER_NO)
	</select>
	
	
	<select id="listmngPayrollAccount" resultMap="memberAccountResultMap">
	SELECT 
           I.COMPANY_NO
         , I.MEMBER_NO
         , I.MEMBER_NAME
         , I.DEPARTMENT_NAME
         , I.RANK
         , I.ACCOUNT_NO
         , I.BANK_NAME	
      FROM (SELECT
                   A.COMPANY_NO
                 , A.MEMBER_NO
                 , A.KOREAN_NAME AS MEMBER_NAME
                 , B.DEPARTMENT_NAME
                 , F.RANK
                 , G.ACCOUNT_NO
                 , H.BANK_NAME
              FROM TBL_EMPLOYEE A
              JOIN TBL_DEPARTMENT B ON (A.DEPARTMENT_NO = B.DEPARTMENT_NO)
              JOIN TBL_EMP_SALARY_STEP C ON (A.MEMBER_NO = C.MEMBER_NO)
              JOIN TBL_RANK_SALARY_STEP F ON (C.SALARY_STEP_BY_RANK = F.SALARY_STEP_BY_RANK)
              JOIN TBL_EMP_ACCOUNT G ON (A.MEMBER_NO = G.MEMBER_NO)
              LEFT JOIN TBL_BANK H ON (G.BANK_CODE = H.BANK_CODE)
             WHERE C.SALARY_STEP_BY_RANK = F.SALARY_STEP_BY_RANK
	        )I
	</select>
	
	
	
	
</mapper>